<script>
const video = document.getElementById("video");
const resultBox = document.getElementById("result");

let reader = null;
let stream = null;
let scanning = false;

function stopCamera() {
  scanning = false;
  if (reader) {
    reader.reset();
    reader = null;
  }
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

async function startScan(formats) {
  stopCamera();
  resultBox.textContent = "Opening camera...";

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  try {
    // THIS is the ONLY place permission can fail
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    scanning = true;
    resultBox.textContent = "Scanning...";

    reader.decodeFromVideoElement(video, (result, err) => {
      if (!scanning) return;

      if (result) {
        resultBox.textContent = "Result: " + result.text;
        stopCamera();
        return;
      }

      // Ignore normal scan failures (this is EXPECTED)
      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error("ZXing error:", err);
      }
    });

  } catch (err) {
    // This runs ONLY if camera truly cannot be accessed
    console.error("getUserMedia error:", err);
    resultBox.textContent = "Camera could not be accessed.";
  }
}

function scanQR() {
  startScan([ZXing.BarcodeFormat.QR_CODE]);
}

function scanBarcode() {
  startScan([
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);
}
</script>
