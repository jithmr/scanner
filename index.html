<script>
const video = document.getElementById("video");
const resultBox = document.getElementById("result");

let reader;
let stream;
let scanning = false;

function stopCamera() {
  scanning = false;
  if (reader) {
    reader.reset();
    reader = null;
  }
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

async function startScan(formats) {
  stopCamera();
  resultBox.textContent = "Opening camera...";

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" }
      }
    });

    video.srcObject = stream;
    scanning = true;
    resultBox.textContent = "Scanning...";

    reader.decodeFromVideoElement(video, (result, err) => {
      if (!scanning) return;

      if (result) {
        resultBox.textContent = "Result: " + result.text;
        stopCamera();
      }

      // IMPORTANT: Ignore NOT_FOUND errors (normal while scanning)
      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err);
      }
    });

  } catch (err) {
    console.error(err);
    resultBox.textContent = "Unable to access camera.";
  }
}

function scanQR() {
  startScan([ZXing.BarcodeFormat.QR_CODE]);
}

function scanBarcode() {
  startScan([
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);
}
</script>
